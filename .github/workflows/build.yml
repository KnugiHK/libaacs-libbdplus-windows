name: libaacs & libbdplus

on:
  create:
    tags:
      - v*
  workflow_dispatch:

jobs:
  build:
    name: Build the Libraries
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
        name: Checkout project
      - name: Install prerequisites
        run: |
          sudo apt-get install -y mingw-w64 mingw-w64-tools mingw-w64-i686-dev gcc make pkg-config fig2dev gettext lbzip2 flex bison nsis
      - name: Build libaacs & libbdplus
        run: |
          x86_64-w64-mingw32-gcc --version
          i686-w64-mingw32-gcc --version
          make
      - name: Packing
        run: |
          mkdir ./win64 ./win86
          cp build-libaacs/install/bin/libaacs.dll ./win64/libaacs.dll
          cp build-libaacs/install/bin/libbdplus.dll ./win64/libbdplus.dll
          cp build-libaacs/install/bin/aacs_info.exe ./win64/aacs_info.exe
          cp build-libaacs-x86/install/bin/libaacs.dll ./win86/libaacs.dll
          cp build-libaacs-x86/install/bin/libbdplus.dll ./win86/libbdplus.dll
          cp build-libaacs-x86/install/bin/aacs_info.exe ./win86/aacs_info.exe
          sha1sum ./win64/* ./win86/*
      - uses: actions/upload-artifact@v6
        with:
          name: libaacs_libbdplus
          path: |
            ./win64
            ./win86
      - name: Make Installer
        run: makensis installer.nsi
      - uses: actions/upload-artifact@v6
        with:
          name: installer
          path: ./libaacs-bdplus.exe
      - name: Build Debug & Testing
        run: |
            x86_64-w64-mingw32-gcc dll_loader.c -o dll_loader_x64.exe
            i686-w64-mingw32-gcc dll_loader.c -o dll_loader_x86.exe
      - uses: actions/upload-artifact@v6
        with:
          name: testing_utility
          path: |
            ./dll_loader_x64.exe
            ./dll_loader_x86.exe
